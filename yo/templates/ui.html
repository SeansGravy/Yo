<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Yo Lite UI</title>
    <style>
      :root {
        color-scheme: light dark;
      }
      body {
        font-family: "Segoe UI", system-ui, sans-serif;
        margin: 0 auto;
        padding: 2rem;
        max-width: 960px;
        background: #f7f7f7;
        color: #222;
      }
      h1, h2 {
        color: #2b3954;
      }
      header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
      }
      header span {
        font-size: 0.9rem;
        color: #555;
      }
      section {
        background: #fff;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        margin-bottom: 2rem;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 1rem;
      }
      th, td {
        border-bottom: 1px solid #e0e0e0;
        padding: 0.75rem 0.5rem;
        text-align: left;
      }
      tbody tr:last-child td {
        border-bottom: none;
      }
      .status-list {
        list-style: none;
        padding: 0;
        margin: 0;
      }
      .status-list li {
        margin-bottom: 0.5rem;
        display: flex;
        gap: 0.5rem;
        align-items: baseline;
      }
      .status-icon {
        font-weight: bold;
      }
      .notice {
        margin-top: 1rem;
        font-size: 0.95rem;
      }
      .notice.warn {
        color: #a84300;
      }
      .notice.error {
        color: #9b1c1c;
      }
      .notice.ok {
        color: #2e7d32;
      }
      .notice.small {
        font-size: 0.85rem;
        color: #555;
      }
      .actions {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 1rem;
        flex-wrap: wrap;
      }
      button {
        background: #2b6cb0;
        color: #fff;
        border: none;
        padding: 0.6rem 1.1rem;
        border-radius: 8px;
        cursor: pointer;
        font-size: 0.95rem;
      }
      button[disabled] {
        background: #9ca3af;
        cursor: not-allowed;
      }
      .alert-row {
        background: #fff0f0;
      }
      .alert-row td {
        color: #8b1e1e;
      }
      .health-summary {
        display: grid;
        gap: 0.3rem;
        font-size: 0.95rem;
      }
      input[type="text"] {
        padding: 0.5rem;
        font-size: 1rem;
        border-radius: 6px;
        border: 1px solid #cbd5e0;
      }
      input[type="file"] {
        font-size: 1rem;
      }
      form .field {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
        margin-bottom: 1rem;
      }
      .warning-banner {
        padding: 0.75rem 1rem;
        border-radius: 8px;
        background: #fff8e1;
        color: #8a5d00;
        margin-bottom: 1rem;
        display: none;
      }
      .warning-banner.active {
        display: block;
      }
      @media (prefers-color-scheme: dark) {
        body {
          background: #111827;
          color: #e5e7eb;
        }
        section {
          background: #1f2937;
          box-shadow: none;
        }
        header span {
          color: #9ca3af;
        }
        th, td {
          border-bottom: 1px solid #374151;
        }
        input[type="text"], input[type="file"] {
          border: 1px solid #4b5563;
          background: #111827;
          color: #e5e7eb;
        }
        .notice.small {
          color: #9ca3af;
        }
        .alert-row {
          background: #3b0f0f;
        }
        .alert-row td {
          color: #fca5a5;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <div>
        <h1>Yo Lite UI</h1>
        <span>Dashboard preview · v{{ app_version }}</span>
      </div>
      <div class="actions">
        <button id="refresh-button" type="button">Refresh Status</button>
      </div>
    </header>
    <div id="status-warning" class="warning-banner"></div>
    <section>
      <h2>Backend Health</h2>
      <ul id="backend-status" class="status-list"></ul>
    </section>
    <section>
      <h2>Health Overview</h2>
      <div id="health-summary" class="health-summary">Loading…</div>
    </section>
    <section>
      <h2>Namespaces</h2>
      <table id="namespace-table">
        <thead>
          <tr>
            <th>Namespace</th>
            <th>Last Ingested</th>
            <th>Documents</th>
            <th>Δ Docs</th>
            <th>Chunks</th>
            <th>Δ Chunks</th>
            <th>Records</th>
            <th>Growth</th>
            <th>Ingests</th>
            <th>Verify Status</th>
            <th>Alerts</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <p id="namespace-caption" class="notice small"></p>
    </section>
    <section>
      <h2>Ingest Documents</h2>
      <p id="ingest-notice" class="notice"></p>
      <form id="ingest-form" enctype="multipart/form-data">
        <div class="field">
          <label for="namespace">Namespace</label>
          <input id="namespace" name="namespace" type="text" value="default" required />
        </div>
        <div class="field">
          <label for="files">Files to ingest</label>
          <input id="files" name="files" type="file" multiple required />
        </div>
        <button id="ingest-submit" type="submit">Upload &amp; Ingest</button>
      </form>
      <div id="ingest-feedback" class="notice"></div>
    </section>
    <script>
      const statusUrl = '/api/status';
      const ingestUrl = '/api/ingest';

      function iconFor(available) {
        return available ? '✅' : '❌';
      }

      const numberFormatter = new Intl.NumberFormat('en-US');

      function formatNumber(value) {
        if (value === null || value === undefined || Number.isNaN(Number(value))) return '—';
        return numberFormatter.format(Number(value));
      }

      function formatDelta(value) {
        if (value === null || value === undefined) return '0';
        const numeric = Number(value);
        if (!Number.isFinite(numeric) || numeric === 0) return '0';
        const prefix = numeric > 0 ? '+' : '';
        return `${prefix}${numberFormatter.format(numeric)}`;
      }

      function formatPercent(value) {
        if (value === null || value === undefined) return '—';
        const numeric = Number(value);
        if (!Number.isFinite(numeric)) return '—';
        return `${numeric.toFixed(1)}%`;
      }

      function renderBackends(backends) {
        const list = document.getElementById('backend-status');
        list.innerHTML = '';
        const rows = [
          ['Milvus Lite runtime', backends.milvus],
          ['Ollama Python bindings', backends.ollama.python],
          ['Ollama CLI', backends.ollama.cli]
        ];
        for (const [label, info] of rows) {
          const item = document.createElement('li');
          const icon = document.createElement('span');
          icon.className = 'status-icon';
          icon.textContent = iconFor(info.available);
          const text = document.createElement('span');
          let detail = info.detail || '';
          if (info.version) {
            detail += detail ? ` (version ${info.version})` : `Version ${info.version}`;
          }
          text.textContent = `${label}: ${detail}`;
          item.appendChild(icon);
          item.appendChild(text);
          list.appendChild(item);
        }
      }

      function renderHealth(health) {
        const container = document.getElementById('health-summary');
        if (!container) {
          return;
        }
        if (!health) {
          container.textContent = 'No telemetry recorded yet. Run `python3 -m yo.cli verify` to populate metrics.';
          return;
        }
        const rawScore = health.score;
        const score = rawScore !== null && rawScore !== undefined ? Math.round(Number(rawScore)) : '—';
        let passRateValue = health.pass_rate;
        if (passRateValue !== null && passRateValue !== undefined) {
          passRateValue = Number(passRateValue);
          passRateValue = passRateValue <= 1 ? passRateValue * 100 : passRateValue;
        }
        const passRate = passRateValue !== null && passRateValue !== undefined && Number.isFinite(passRateValue)
          ? `${passRateValue.toFixed(1)}%`
          : '—';
        const status = health.latest_status || 'Unknown';
        const timestamp = health.timestamp ? new Date(health.timestamp).toLocaleString() : '—';
        container.innerHTML = `
          <p><strong>Health Score:</strong> ${score}</p>
          <p><strong>Pass Rate:</strong> ${passRate}</p>
          <p><strong>Last Verify:</strong> ${status}</p>
          <p><strong>Updated:</strong> ${timestamp}</p>
        `;
      }

      function renderNamespaces(namespaces, driftWindow) {
        const tbody = document.querySelector('#namespace-table tbody');
        tbody.innerHTML = '';
        if (!Array.isArray(namespaces) || namespaces.length === 0) {
          const row = document.createElement('tr');
          const cell = document.createElement('td');
          cell.colSpan = 11;
          cell.textContent = 'No namespaces available yet.';
          row.appendChild(cell);
          tbody.appendChild(row);
          const caption = document.getElementById('namespace-caption');
          if (caption) caption.textContent = '';
          return;
        }
        for (const ns of namespaces) {
          const row = document.createElement('tr');
          if (ns.alerts && ns.alerts.length) {
            row.classList.add('alert-row');
          }
          const growth = ns.growth_percent !== undefined && ns.growth_percent !== null
            ? formatPercent(Number(ns.growth_percent))
            : '—';
          const fields = [
            ns.name,
            ns.last_ingested ? new Date(ns.last_ingested).toLocaleString() : '—',
            formatNumber(ns.documents),
            formatDelta(ns.documents_delta),
            formatNumber(ns.chunks),
            formatDelta(ns.chunks_delta),
            formatNumber(ns.records),
            growth,
            ns.ingest_runs ?? '—',
            ns.last_verify_status ?? '—',
            Array.isArray(ns.alerts) && ns.alerts.length ? ns.alerts.join('; ') : '—',
          ];
          for (const value of fields) {
            const cell = document.createElement('td');
            cell.textContent = value;
            row.appendChild(cell);
          }
          tbody.appendChild(row);
        }
        const caption = document.getElementById('namespace-caption');
        if (caption) {
          caption.textContent = `Growth reflects cumulative change over the last ${driftWindow || 'recent runs'}.`;
        }
      }

      function updateNotice(element, message, type) {
        element.textContent = message;
        element.className = `notice ${type}`.trim();
      }

      function updateIngestionState(ingestion) {
        const button = document.getElementById('ingest-submit');
        const fileInput = document.getElementById('files');
        const notice = document.getElementById('ingest-notice');
        if (!ingestion.enabled) {
          button.disabled = true;
          fileInput.disabled = true;
          updateNotice(notice, ingestion.reason || 'Ingestion disabled until backends are available.', 'warn');
        } else {
          button.disabled = false;
          fileInput.disabled = false;
          updateNotice(notice, 'Upload files to ingest them into your selected namespace.', 'ok');
        }
      }

      function updateWarningBanner(warning) {
        const banner = document.getElementById('status-warning');
        if (warning) {
          banner.textContent = warning;
          banner.classList.add('active');
        } else {
          banner.textContent = '';
          banner.classList.remove('active');
        }
      }

      async function refreshStatus() {
        try {
          const response = await fetch(statusUrl, { cache: 'no-store' });
          const data = await response.json();
          renderBackends(data.backends);
          renderHealth(data.health);
          renderNamespaces(data.namespaces, data.drift_window);
          updateIngestionState(data.ingestion);
          updateWarningBanner(data.warning);
        } catch (error) {
          updateWarningBanner('Unable to load status: ' + error);
        }
      }

      document.getElementById('refresh-button').addEventListener('click', refreshStatus);

      document.getElementById('ingest-form').addEventListener('submit', async (event) => {
        event.preventDefault();
        const feedback = document.getElementById('ingest-feedback');
        updateNotice(feedback, 'Uploading…', '');
        const form = event.currentTarget;
        const formData = new FormData(form);
        try {
          const response = await fetch(ingestUrl, {
            method: 'POST',
            body: formData,
          });
          if (!response.ok) {
            const payload = await response.json().catch(() => ({}));
            const message = payload.detail || 'Ingestion failed.';
            updateNotice(feedback, `❌ ${message}`, 'error');
          } else {
            const payload = await response.json();
            const info = payload.ingest || {};
            const docCount = info.documents_ingested ?? '0';
            const chunkCount = info.chunks_ingested ?? '0';
            updateNotice(
              feedback,
              `✅ Ingested ${docCount} documents / ${chunkCount} chunks into "${info.namespace || formData.get('namespace')}".`,
              'ok'
            );
            form.reset();
            document.getElementById('namespace').value = info.namespace || 'default';
            refreshStatus();
          }
        } catch (error) {
          updateNotice(feedback, `❌ Upload failed: ${error}`, 'error');
        }
      });

      refreshStatus();
      setInterval(refreshStatus, 15000);
    </script>
  </body>
</html>
